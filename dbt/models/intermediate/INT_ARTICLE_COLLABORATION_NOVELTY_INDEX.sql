WITH REF_INT_COLLABORATION_NOVELTY_AUTHOR_COLLABORATION
    AS (SELECT *
        FROM {{ ref('INT_COLLABORATION_NOVELTY_AUTHOR_COLLABORATION')}})
   , REF_INT_COLLABORATION_NOVELTY_INSTITUTION_COLLABORATION
    AS (SELECT *
        FROM {{ ref('INT_COLLABORATION_NOVELTY_INSTITUTION_COLLABORATION')}})
   , NEW_INSTITUTION_IMPACT
    AS (SELECT CI.ARTICLE_SID,
               SUM(1 / (1 + CI.PRIOR_COLLABORATION_COUNT)) AS NEW_INSTITUTIONS_IMPACT,
        FROM REF_INT_COLLABORATION_NOVELTY_INSTITUTION_COLLABORATION CI
        WHERE CI.INSTITUTION_SID < CI.COLLABORATOR_INSTITUTION_SID
        GROUP BY CI.ARTICLE_SID)
   , NEW_AUTHOR_IMPACT
    AS (SELECT CA.ARTICLE_SID,
               SUM(1 / (1 + CA.PRIOR_COLLABORATION_COUNT)) AS NEW_AUTHORS_IMPACT,
        FROM REF_INT_COLLABORATION_NOVELTY_AUTHOR_COLLABORATION CA
        WHERE CA.COLLABORATOR_AUTHOR_SID < CA.AUTHOR_SID
        GROUP BY CA.ARTICLE_SID)
   , COLLABORATION_IMPACT
    AS (SELECT CA.ARTICLE_SID,
               NAI.NEW_AUTHORS_IMPACT,
               NII.NEW_INSTITUTIONS_IMPACT,
               COUNT(DISTINCT
                     IF(CA.PRIOR_COLLABORATION_COUNT = 0, CA.AUTHOR_SID, NULL))      AS NEW_AUTHORS_COUNT,
               COUNT(DISTINCT
                     IF(CI.PRIOR_COLLABORATION_COUNT = 0, CI.INSTITUTION_SID, NULL)) AS NEW_INSTITUTIONS_COUNT,
               COUNT(DISTINCT CA.AUTHOR_SID)                                         AS TOTAL_AUTHORS_COUNT,
               COUNT(DISTINCT CI.INSTITUTION_SID)                                    AS TOTAL_INSTITUTIONS_COUNT,
        FROM REF_INT_COLLABORATION_NOVELTY_AUTHOR_COLLABORATION CA
                 LEFT JOIN REF_INT_COLLABORATION_NOVELTY_INSTITUTION_COLLABORATION CI
                           ON CA.ARTICLE_SID = CI.ARTICLE_SID
                 LEFT JOIN NEW_AUTHOR_IMPACT NAI
                           ON CA.ARTICLE_SID = NAI.ARTICLE_SID
                 LEFT JOIN NEW_INSTITUTION_IMPACT NII
                           ON CI.ARTICLE_SID = NII.ARTICLE_SID
        WHERE CA.COLLABORATOR_AUTHOR_SID < CA.AUTHOR_SID
          AND (CI.INSTITUTION_SID IS NULL OR CI.COLLABORATOR_INSTITUTION_SID < CI.INSTITUTION_SID)
        GROUP BY CA.ARTICLE_SID, NAI.NEW_AUTHORS_IMPACT, NII.NEW_INSTITUTIONS_IMPACT)
SELECT CI.ARTICLE_SID,
       CI.NEW_AUTHORS_IMPACT,
       CI.NEW_INSTITUTIONS_IMPACT,
       CI.NEW_AUTHORS_COUNT,
       CI.NEW_INSTITUTIONS_COUNT,
       CI.TOTAL_AUTHORS_COUNT,
       CI.TOTAL_INSTITUTIONS_COUNT,
       CI.NEW_AUTHORS_IMPACT *
       (1 + CI.NEW_INSTITUTIONS_IMPACT) *
       (1 / ((TOTAL_AUTHORS_COUNT - NEW_AUTHORS_COUNT) + 1)) AS COLLABORATION_NOVELTY_INDEX
FROM COLLABORATION_IMPACT CI
